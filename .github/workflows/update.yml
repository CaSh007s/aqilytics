name: Hourly AQI Update
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch AQI (WAQI)
        run: |
          python src/data/fetch_aqi.py mumbai
          python src/data/fetch_aqi.py delhi
          python src/data/fetch_aqi.py bangalore
          python src/data/fetch_aqi.py kolkata
          python src/data/fetch_aqi.py bhopal
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}

      - name: Fetch Weather
        run: |
          python src/data/fetch_weather.py mumbai
          python src/data/fetch_weather.py delhi
          python src/data/fetch_weather.py bangalore
          python src/data/fetch_weather.py kolkata
          python src/data/fetch_weather.py bhopal
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}

      - name: Fetch CPCB PM2.5 (Real India Data)
        run: |
          python src/data/fetch_cpcb.py mumbai
          python src/data/fetch_cpcb.py delhi
          python src/data/fetch_cpcb.py bangalore
          python src/data/fetch_cpcb.py kolkata
          python src/data/fetch_cpcb.py bhopal
        env:
          CPCB_KEY: ${{ secrets.CPCB_KEY }}

      - name: Merge & Train
        run: |
          python src/features/merge_data.py mumbai
          python src/features/merge_data.py delhi
          python src/features/merge_data.py bangalore
          python src/features/merge_data.py kolkata
          python src/features/merge_data.py bhopal

          python src/models/train.py mumbai
          python src/models/train.py delhi
          python src/models/train.py bangalore
          python src/models/train.py kolkata
          python src/models/train.py bhopal

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/ models/
          git commit -m "auto: hourly update $(date -u)" || exit 0
          git push origin main