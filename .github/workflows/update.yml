# .github/workflows/update.yml
name: Hourly AQI Update
on:
  schedule:
    - cron: '0 * * * *'   # Every hour
  workflow_dispatch:      # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch AQI (WAQI)
        run: |
          python src/data/fetch_aqi.py mumbai
          python src/data/fetch_aqi.py delhi
          python src/data/fetch_aqi.py bangalore
          python src/data/fetch_aqi.py kolkata
          python src/data/fetch_aqi.py bhopal
        env:
          WAQI_TOKEN: ${{ secrets.WAQI_TOKEN }}

      - name: Fetch Weather (OpenWeather)
        run: |
          python src/data/fetch_weather.py mumbai
          python src/data/fetch_weather.py delhi
          python src/data/fetch_weather.py bangalore
          python src/data/fetch_weather.py kolkata
          python src/data/fetch_weather.py bhopal
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}

      - name: Merge data & Train models
        run: |
          for city in mumbai delhi bangalore kolkata bhopal; do
            python src/features/merge_data.py $city
            python src/models/train.py $city
          done

      - name: Commit & Push updated data/models
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.AQI_PUSH_TOKEN }}@github.com/${{ github.repository }}.git
          
          git add data/ models/
          
          if ! git diff-index --quiet HEAD; then
            git commit -m "auto: hourly data update $(date -u +'%Y-%m-%d %H:%M')"
            git push origin main
            echo "Successfully pushed new data"
          else
            echo "No changes to commit"
          fi